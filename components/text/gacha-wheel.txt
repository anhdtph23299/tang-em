"use client"

import { useState, useEffect } from "react"
import GachaWheelModal from "./gacha-wheel-modal"

// Hi·ªáu ·ª©ng ph√°o gi·∫•y ƒë∆°n gi·∫£n
const confettiDots = Array.from({ length: 40 }, (_, i) => i)

export default function GiftBox() {
    const [opened, setOpened] = useState(false)
    const [showConfetti, setShowConfetti] = useState(false)
    const [showGachaModal, setShowGachaModal] = useState(false)
    const [hasClaimed, setHasClaimed] = useState(false)

    // Ki·ªÉm tra xem ƒë√£ "d√≠nh b·∫´y" ch∆∞a ƒë·ªÉ ch·∫∑n kh√¥ng cho quay l·∫°i
    useEffect(() => {
        const isClaimed = localStorage.getItem("reward_claimed") === "bf_jackpot"
        if (isClaimed) {
            setHasClaimed(true)
        }
    }, [])

    const handleOpenBox = () => {
        if (opened) return
        setOpened(true)
        setShowConfetti(true)
        // T·ª± ƒë·ªông t·∫Øt ph√°o gi·∫•y sau 4 gi√¢y cho ƒë·ª° n·∫∑ng m√°y
        setTimeout(() => setShowConfetti(false), 4000)
    }

    const handleGachaClick = () => {
        // N·∫øu ƒë√£ quay r·ªìi th√¨ kh√¥ng cho hi·ªán modal n·ªØa, ho·∫∑c hi·ªán th√¥ng b√°o troll
        if (hasClaimed) {
            alert("ƒê·ªãnh m·ªánh ch·ªâ g√µ c·ª≠a m·ªôt l·∫ßn th√¥i b√© ∆°i! ‚ù§Ô∏è")
            return
        }
        setShowGachaModal(true)
    }

    const onSpinFinished = (rewardIndex: number) => {
        setHasClaimed(true)
        localStorage.setItem("reward_claimed", "bf_jackpot")
        localStorage.setItem("reward_index", String(rewardIndex))
        // Sau khi quay xong trong Modal, Modal ƒë√≥ t·ª± ƒë√≥ng ho·∫∑c x·ª≠ l√Ω hi·ªÉn th·ªã ƒë√£ ƒë∆∞·ª£c
        // h√†m setShowGachaModal(false) lo li·ªáu trong logic c·ªßa Modal
    }

    return (
        <section className="relative px-4 py-24 min-h-[600px] flex flex-col items-center justify-start overflow-hidden">
            {/* CSS Animations */}
            <style>{`
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fall { 
          0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-fall { animation: fall 4s linear forwards; }
        .perspective { perspective: 1000px; }
      `}</style>

            {/* Ph√°o gi·∫•y khi m·ªü qu√† */}
            {showConfetti && (
                <div className="fixed inset-0 pointer-events-none z-50">
                    {confettiDots.map((i) => (
                        <div
                            key={i}
                            className="absolute text-2xl animate-fall"
                            style={{
                                left: `${Math.random() * 100}%`,
                                animationDelay: `${Math.random() * 2}s`,
                                color: i % 2 === 0 ? '#fb7185' : '#fbbf24'
                            }}
                        >
                            {i % 3 === 0 ? "‚ú®" : i % 3 === 1 ? "‚ùÑÔ∏è" : "‚ù§Ô∏è"}
                        </div>
                    ))}
                </div>
            )}

            <div className="max-w-xl w-full text-center z-10">
                <h2 className="text-4xl md:text-5xl font-extrabold text-rose-600 mb-16 drop-shadow-sm">
                    Special Gift üéÅ
                </h2>

                {/* Khu v·ª±c H·ªôp Qu√† */}
                <div className="relative h-64 flex items-center justify-center mb-10 perspective">
                    {!opened ? (
                        <div
                            onClick={handleOpenBox}
                            className="group relative cursor-pointer transform transition-all duration-500 hover:scale-110 active:scale-95"
                        >
                            {/* √Ånh s√°ng lung linh quanh h·ªôp */}
                            <div className="absolute inset-[-20px] bg-rose-300/30 blur-3xl rounded-full animate-pulse" />

                            <div className="relative text-9xl md:text-[12rem] animate-float drop-shadow-2xl">
                                üéÅ
                                <p className="absolute -bottom-10 left-1/2 -translate-x-1/2 w-max text-sm font-bold text-rose-400 opacity-0 group-hover:opacity-100 transition-opacity uppercase tracking-widest">
                                    Ch·∫°m ƒë·ªÉ m·ªü ‚Ä¢ Click to Open
                                </p>
                            </div>
                        </div>
                    ) : (
                        /* Khi ƒë√£ m·ªü: Hi·ªán V√© Y√™u Em */
                        <div className="animate-in fade-in zoom-in duration-1000 w-full max-w-md">
                            <div className="bg-white rounded-3xl p-6 shadow-[0_20px_50px_rgba(251,113,133,0.2)] border-2 border-rose-100 relative overflow-hidden">

                                {/* Decor l∆∞·ª£n s√≥ng */}
                                <div className="absolute -top-10 -right-10 w-32 h-32 bg-rose-50 rounded-full" />
                                <div className="absolute -bottom-10 -left-10 w-24 h-24 bg-pink-50 rounded-full" />

                                <div className="relative">
                                    <div className="flex justify-center items-center gap-2 mb-4">
                                        <span className="text-rose-500 text-xl">üé´</span>
                                        <h3 className="text-2xl font-black text-rose-700 tracking-tighter uppercase">V√© Y√™u Em</h3>
                                        <span className="text-rose-500 text-xl">üé´</span>
                                    </div>

                                    {/* Ticket UI */}
                                    <div className="border-4 border-dashed border-rose-300 rounded-2xl p-6 bg-gradient-to-br from-white to-rose-50 relative">
                                        {/* D·∫•u ƒë·ªè Ch√≠nh Ch·ªß */}
                                        <div className="absolute bottom-4 right-4 border-4 border-rose-600/30 text-rose-600/30 font-black px-2 py-1 rounded-md rotate-[-15deg] text-xs pointer-events-none uppercase">
                                            Ch√≠nh Ch·ªß <br/> LOVE-2025
                                        </div>

                                        <p className="text-3xl font-black text-rose-600 mb-6 tracking-widest italic">LOVE2025</p>

                                        <ul className="text-left space-y-3 text-gray-700 text-sm md:text-base font-medium mb-8">
                                            <li>‚ú® <span className="font-bold">Quy·ªÅn l·ª£i:</span> Tr·ªçn ƒë·ªùi b√™n anh</li>
                                            <li>üíù <span className="font-bold">B·∫£o h√†nh:</span> Y√™u th∆∞∆°ng v√¥ ƒëi·ªÅu ki·ªán</li>
                                            <li>‚åõ <span className="font-bold">Th·ªùi h·∫°n:</span> M√£i m√£i kh√¥ng phai</li>
                                        </ul>

                                        {/* N√öT K√çCH HO·∫†T C√ö B·ªäP */}
                                        <button
                                            onClick={handleGachaClick}
                                            className={`w-full py-4 rounded-xl font-black text-white transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2 
                           ${hasClaimed
                                                ? "bg-gray-400 cursor-not-allowed"
                                                : "bg-gradient-to-r from-amber-400 to-orange-500 hover:from-orange-500 hover:to-amber-400 animate-pulse"}`}
                                        >
                                            {hasClaimed ? "‚úì ƒê√£ nh·∫≠n ƒë·ªãnh m·ªánh" : "üíé B·∫§M ƒê·ªÇ NH·∫¨N QU√Ä ƒê√çNH K√àM"}
                                        </button>
                                    </div>

                                    <button
                                        onClick={() => setOpened(false)}
                                        className="mt-6 text-gray-400 hover:text-rose-400 text-sm font-bold uppercase transition-colors"
                                    >
                                        √ó ƒê√≥ng m√≥n qu√† √ó
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {/* V√íNG QUAY ƒê·ªäNH M·ªÜNH MODAL (Ph·∫ßn n√†y s·∫Ω hi·ªán Modal b·ªëc Jackpot) */}
            {showGachaModal && (
                <GachaWheelModal
                    onClose={() => setShowGachaModal(false)}
                    onJackpotClaimed={onSpinFinished}
                />
            )}
        </section>
    )
}